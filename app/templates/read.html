{% extends "base.html" %}

{% block extra_head %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body.read-view {
      background-color: #f6f8fa;
      color: #0b0f14;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.65;
    }

    body.read-view a {
      color: #0969da;
    }

    body.read-view nav a {
      background-color: #eaeef2 !important;
      color: #24292f !important;
    }

    body.read-view nav a:hover {
      background-color: #d0d7de !important;
    }

    .markdown-body {
      box-sizing: border-box;
      min-width: 200px;
      max-width: 900px;
      margin: 0 auto;
      padding: 2.5rem 3rem;
      background: white;
      border: 1px solid #d0d7de;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(140, 149, 159, 0.2);
      font-size: 17px;
      color: #0b0f14;
    }

    .markdown-body p,
    .markdown-body li {
      line-height: 1.7;
      color: #0b0f14;
    }

    .markdown-body h1,
    .markdown-body h2,
    .markdown-body h3,
    .markdown-body h4 {
      font-weight: 600;
      line-height: 1.25;
    }

    .markdown-body pre {
      background-color: #f6f8fa;
      color: #0b0f14;
      border: 1px solid #d0d7de;
      border-radius: 8px;
    }

    .markdown-body code {
      color: #0b0f14;
      background-color: rgba(27, 31, 35, 0.05);
      border-radius: 6px;
      padding: 0.15em 0.35em;
    }

    .markdown-body pre code {
      background: transparent;
      padding: 0;
      border-radius: 0;
      color: inherit;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="flex items-start justify-between gap-4">
    <div>
      <h1 class="text-3xl font-semibold text-slate-900">{{ job.topic }}</h1>
      <div class="mt-1 text-slate-600">Rendered book</div>
    </div>
    <div class="text-right">
      <a class="text-sm text-slate-700 hover:text-slate-900" href="/jobs/{{ job.id }}">Back to job</a>
    </div>
  </div>

  <div class="mt-6 overflow-hidden">
    <article class="markdown-body">
      {{ html_body | safe }}
    </article>
  </div>

  <div class="mt-6 bg-white rounded-lg shadow p-4 text-slate-900">
    <div class="text-sm font-medium">Read aloud</div>
    <div class="mt-3 flex flex-wrap items-center gap-3">
      <label class="text-sm">Voice (speaker)
        <input id="tts-voice" list="tts-voices" class="ml-2 border rounded px-2 py-1 text-sm" value="{{ local_tts_default_voice or 'p225' }}" />
        <datalist id="tts-voices">
          <option value="p225"></option>
          <option value="p226"></option>
          <option value="p227"></option>
          <option value="p228"></option>
          <option value="p229"></option>
          <option value="p230"></option>
          <option value="p231"></option>
          <option value="p232"></option>
        </datalist>
      </label>
      <label class="text-sm">Speed
        <input id="tts-speed" type="number" min="0.5" max="2.0" step="0.1" value="1.0" class="ml-2 w-20 border rounded px-2 py-1 text-sm" />
      </label>
      <button id="tts-play" class="bg-slate-900 text-white rounded px-3 py-2 text-sm hover:bg-slate-800" type="button">Generate & Play</button>
      <span id="tts-status" class="text-xs text-slate-500"></span>
    </div>
    <audio id="tts-audio" class="mt-3 w-full" controls></audio>
  </div>

  <script>
    const playBtn = document.getElementById('tts-play');
    const audioEl = document.getElementById('tts-audio');
    const statusEl = document.getElementById('tts-status');
    playBtn.addEventListener('click', async () => {
      statusEl.textContent = 'Generating audio...';
      const voice = document.getElementById('tts-voice').value;
      const speed = document.getElementById('tts-speed').value;
      const params = new URLSearchParams();
      params.append('voice', voice);
      params.append('speed', speed);
      try {
        const resp = await fetch(`/jobs/{{ job.id }}/tts`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: params.toString()
        });
        if (!resp.ok) {
          const data = await resp.json();
          statusEl.textContent = data.detail || 'Failed to generate audio.';
          return;
        }
        const blob = await resp.blob();
        audioEl.src = URL.createObjectURL(blob);
        await audioEl.play();
        statusEl.textContent = '';
      } catch (err) {
        statusEl.textContent = 'Failed to generate audio.';
      }
    });
  </script>
{% endblock %}
